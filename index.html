<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enrollment vs Graduates Over Time</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    #controls { margin-bottom: 1rem; }
    .chart-container { position: relative; width: 100%; max-width: 900px; margin: auto; }
  </style>
</head>
<body>

  <h1>Enrollment vs Graduated Over Time</h1>

  <div id="controls">
    <label for="cipFilter">CIP Code / Cert Title:</label>
    <select id="cipFilter"></select>
    <label for="instFilter" style="margin-left:1rem;">Institution:</label>
    <select id="instFilter"></select>
  </div>

  <div class="chart-container">
    <canvas id="timeChart"></canvas>
  </div>

  <script>
    // Path to your CSV file
    const csvPath = 'data/program_data.csv';

    let rawData;
    let chart;

    // Load CSV
    Papa.parse(csvPath, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        rawData = results.data;
        initFilters();
        drawChart();
      }
    });

    function initFilters() {
      const cips = [...new Set(rawData.map(r => r.CIP_Code + ' - ' + r.Cert_Title))];
      const insts = [...new Set(rawData.map(r => r.Institution))];

      const cipSelect = document.getElementById('cipFilter');
      const instSelect = document.getElementById('instFilter');

      cips.forEach(c => cipSelect.add(new Option(c, c)));
      insts.forEach(i => instSelect.add(new Option(i, i)));

      cipSelect.onchange = drawChart;
      instSelect.onchange = drawChart;
    }

    function drawChart() {
      const cip = document.getElementById('cipFilter').value;
      const inst = document.getElementById('instFilter').value;

      // Filter data
      const filtered = rawData.filter(r =>
        (!cip || (r.CIP_Code + ' - ' + r.Cert_Title) === cip) &&
        (!inst || r.Institution === inst)
      );

      // Group by Year
      const years = [...new Set(filtered.map(r => r.Year))].sort((a,b) => a - b);
      const enrollment = years.map(y => {
        const rec = filtered.find(r => r.Year === y);
        return rec ? rec.Enrollment : null;
      });
      const graduates = years.map(y => {
        const rec = filtered.find(r => r.Year === y);
        return rec ? rec.Graduated : null;
      });

      const ctx = document.getElementById('timeChart').getContext('2d');

      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            {
              label: 'Enrollment',
              data: enrollment,
              borderColor: 'rgba(75, 192, 192, 1)',
              fill: false,
              tension: 0.3
            },
            {
              label: 'Graduated',
              data: graduates,
              borderColor: 'rgba(153, 102, 255, 1)',
              fill: false,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: cip + ' @ ' + inst },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false },
          scales: {
            x: { title: { display: true, text: 'Year' } },
            y: { title: { display: true, text: 'Count' }, beginAtZero: true }
          }
        }
      });
    }
  </script>

</body>
</html>
